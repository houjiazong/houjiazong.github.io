---
title: é˜¿é‡ŒOSSå‰ç«¯ç›´ä¼ æ–¹æ¡ˆ
---

# é˜¿é‡ŒOSSå‰ç«¯ç›´ä¼ æ–¹æ¡ˆ
## èƒŒæ™¯

æ¯ä¸ªOSSçš„ç”¨æˆ·éƒ½ä¼šç”¨åˆ°ä¸Šä¼ æœåŠ¡ã€‚Webç«¯å¸¸è§çš„ä¸Šä¼ æ–¹æ³•æ˜¯ç”¨æˆ·åœ¨æµè§ˆå™¨æˆ–Appç«¯ä¸Šä¼ æ–‡ä»¶åˆ°åº”ç”¨æœåŠ¡å™¨ï¼Œåº”ç”¨æœåŠ¡å™¨å†æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°OSSã€‚å…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![image](../../.vuepress/public/images/vue/1.png)

å’Œæ•°æ®ç›´ä¼ åˆ°OSSç›¸æ¯”ï¼Œä»¥ä¸Šæ–¹æ³•æœ‰ä¸‰ä¸ªç¼ºç‚¹ï¼š

- ä¸Šä¼ æ…¢ï¼šç”¨æˆ·æ•°æ®éœ€å…ˆä¸Šä¼ åˆ°åº”ç”¨æœåŠ¡å™¨ï¼Œä¹‹åå†ä¸Šä¼ åˆ°OSSã€‚ç½‘ç»œä¼ è¾“æ—¶é—´æ¯”ç›´ä¼ åˆ°OSSå¤šä¸€å€ã€‚å¦‚æœç”¨æˆ·æ•°æ®ä¸é€šè¿‡åº”ç”¨æœåŠ¡å™¨ä¸­è½¬ï¼Œè€Œæ˜¯ç›´ä¼ åˆ°OSSï¼Œé€Ÿåº¦å°†å¤§å¤§æå‡ã€‚è€Œä¸”OSSé‡‡ç”¨BGPå¸¦å®½ï¼Œèƒ½ä¿è¯å„åœ°å„è¿è¥å•†ä¹‹é—´çš„ä¼ è¾“é€Ÿåº¦ã€‚
- æ‰©å±•æ€§å·®ï¼šå¦‚æœåç»­ç”¨æˆ·å¤šäº†ï¼Œåº”ç”¨æœåŠ¡å™¨ä¼šæˆä¸ºç“¶é¢ˆã€‚
- è´¹ç”¨é«˜ï¼šéœ€è¦å‡†å¤‡å¤šå°åº”ç”¨æœåŠ¡å™¨ã€‚ç”±äºOSSä¸Šä¼ æµé‡æ˜¯å…è´¹çš„ï¼Œå¦‚æœæ•°æ®ç›´ä¼ åˆ°OSSï¼Œä¸é€šè¿‡åº”ç”¨æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå°†èƒ½çœä¸‹å‡ å°åº”ç”¨æœåŠ¡å™¨ã€‚

## æ–¹æ¡ˆ

- [OSS Browser.js SDK](https://www.alibabacloud.com/help/zh/doc-detail/64041.htm?spm=a2c63.p38356.879954.5.424a3095oAbtmE#concept-64041-zh)
- [PostObjectæ¥å£](https://www.alibabacloud.com/help/zh/doc-detail/31988.htm?spm=a2c63.p38356.879954.6.424a3095oAbtmE#reference-smp-nsw-wdb)

### ä¸¤ç§æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹

Browser.js SDKä¼˜ç‚¹æ˜¯å¯ä»¥åˆ©ç”¨å®˜æ–¹æä¾›çš„å°è£…å¥½çš„SDKä½¿ç”¨ç®€å•ï¼Œè¯´æ˜æ–‡æ¡£ç›¸å¯¹æ¯”è¾ƒå®Œæ•´ã€‚ç¼ºç‚¹æ˜¯ä¼šæŠŠAccessKeyIdå’ŒAccessKeySecretæš´éœ²åœ¨å‰ç«¯ï¼Œå®‰å…¨æ€§æä½

PostObjectçš„æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼š
- ç¬¬ä¸€ç§ä¸ºå‰ç«¯ç›´æ¥è¿›è¡Œç­¾åç›´ä¼ ï¼Œè¿™ç§æ–¹å¼å’ŒBrowser.js SDKçš„ç¼ºç‚¹åŒæ ·æ˜æ˜¾ï¼Œå°±æ˜¯ä¼šæŠŠAccessKeyIdå’ŒAccessKeySecretæš´éœ²åœ¨å‰ç«¯
- ç¬¬äºŒç§ä¸ºæœåŠ¡ç«¯ç­¾åå‰ç«¯ç›´ä¼ çš„æ–¹å¼ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©çš„æ–¹æ¡ˆï¼Œæµç¨‹å¦‚ä¸‹å›¾

![image](../../.vuepress/public/images/vue/2.png)

## äºŒæ¬¡å°è£…Element UI Uploadç»„ä»¶å®ç°OSSæœåŠ¡ç«¯ç­¾åå‰ç«¯ç›´ä¼ 

```javascript
import Upload from 'element-ui/lib/upload'
import axios from 'axios'
import { uuidv4 } from './util'
// import { uuidv4, getPolicyBase64, getSignature } from './util'
// import config, { POLICY_INFO_SESSION_KEY } from './config'
import { POLICY_INFO_SESSION_KEY } from './config'
import http from './http'
import storage from '../utils/storage'

function MOSSUpload (WrappedComponent) {
  return {
    name: 'MOSSUpload',
    props: {
      ...WrappedComponent.props,
    },
    created () {
      // è®°å½•æ¯æ¬¡ä¸Šä¼ çš„æ–‡ä»¶
      this._uploadFile = null
      // åˆå§‹åŒ–ä¸Šä¼ æ‰€éœ€data
      this._ossParams = {
        key: '',
        name: '',
        policy: '',
        OSSAccessKeyId: '',
        signature: '',
        success_action_status: '200',
        host: '',
      }
    },
    mounted () {
      this.$nextTick(() => {
        // åŸæœ‰æ–¹æ³•proxy
        const methods = Object.keys(Upload.methods)
        methods.forEach((item) => {
          this[item] = this.$refs['m-oss-upload'][item]
        })
      })
    },
    methods: {
      async _getOSSParams () {
        // åç«¯ç­¾åï¼Œå‰ç«¯ç›´ä¼ 
        const info = storage.session.get(POLICY_INFO_SESSION_KEY, {})
        let expire = 0
        if (info.expire) {
          expire = Number(info.expire) * 1000
        }
        let params = info
        // å·²è¿‡æœŸ
        if (expire - Date.now() < 1000 * 20) {
          try {
            const { data } = await http.get('/v1/oss/policy')
            const _ossParams = data.data
            storage.session.set(POLICY_INFO_SESSION_KEY, _ossParams)
            params = _ossParams
          } catch (error) {
            console.error(error)
          }
        }
        return Promise.resolve(params)

        // å‰ç«¯ç­¾åç›´ä¼ 
        // const policy = getPolicyBase64()
        // return {
        //   policy,
        //   signature: getSignature(policy),
        //   host: config.uploadImageUrl,
        //   accessid: config.OSSAccessKeyId,
        // }
      },
      async _beforeUpload (file) {
        // props å«æœ‰ beforeUpload ä¼˜å…ˆæ‰§è¡Œ.æ”¯æŒpromise
        if (this.$props.beforeUpload) {
          try {
            const ret = await this.$props.beforeUpload(file)
            if (!ret) return Promise.reject(ret)
          } catch (error) {
            return Promise.reject(error)
          }
        }
        try {
          const _ossParams = await this._getOSSParams()
          const suffix = file.type.split('/')[1]
          this._uploadFile = file
          this._ossParams.key = `${_ossParams.dir}${uuidv4()}-${+new Date()}.${suffix}`
          this._ossParams.name = file.name
          this._ossParams.policy = _ossParams.policy
          this._ossParams.OSSAccessKeyId = _ossParams.accessid
          this._ossParams.signature = _ossParams.signature
          this._ossParams.host = _ossParams.host
          this._ossParams.success_action_status = '200'
          return Promise.resolve(this._ossParams)
        } catch (error) {
          this.$message.error(error.message)
          return Promise.reject(error)
        }
      },
      _onSuccess (response, file, fileList) {
        file.$key = this._ossParams.key
        if (typeof this.onSuccess === 'function') {
          this.onSuccess(response, file, fileList)
        }
      },
      _doUpload () {
        const { host, ...rest } = this._ossParams
        const fd = new FormData()
        for (const key in rest) {
          fd.append(key, rest[key])
        }
        fd.append('file', this._uploadFile)
        return axios.post(host, fd, {
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        })
      },
      renderUpload (h) {
        const slots = Object.keys(this.$slots)
          .reduce((result, name) => {
            return result.concat(this.$slots[name])
          }, [])
          .map(vnode => {
            vnode.context = this._self
            return vnode
          })
        return h(WrappedComponent, {
          ref: 'm-oss-upload',
          props: {
            ...this.$props,
            beforeUpload: this._beforeUpload,
            onSuccess: this._onSuccess,
            httpRequest: this._doUpload,
          },
          on: this.$listeners,
          scopedSlots: this.$scopedSlots,
          attr: this.$attrs,
        }, slots)
      },
    },
    render (h) {
      return h('div', {
        class: 'm-oss-upload',
      }, [
        this.renderUpload(h),
      ])
    },
  }
}

export default MOSSUpload(Upload)
```

å› ä¸ºé¡¹ç›®æ˜¯åŸºäºElement UIå¼€å‘çš„ï¼Œæ‰€ä»¥ä½¿ç”¨[HOC](http://hcysun.me/2018/01/05/%E6%8E%A2%E7%B4%A2Vue%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6/)çš„å½¢å¼å¯¹el-uploadè¿›è¡Œå°è£…ï¼Œè¿™æ ·çš„å¥½å¤„å³å¯ä»¥æŠŠOSSçš„ä¸šåŠ¡é€»è¾‘å°è£…èµ·æ¥ï¼Œåˆå¯ä»¥ä¿ç•™el-uploadçš„æ‰€æœ‰API

## ä¸€äº›è¾…åŠ©çš„Utils

bytes.js å°†å­—ç¬¦ä¸²å­—èŠ‚ï¼ˆå¦‚1KBï¼‰è½¬æ¢ä¸ºå­—èŠ‚ï¼ˆ1024ï¼‰
```javascript
const formatThousandsRegExp = /\B(?=(\d{3})+(?!\d))/g

const formatDecimalsRegExp = /(?:\.0*|(\.[^0]+)0+)$/

const map = {
  b: 1,
  kb: 1 << 10,
  mb: 1 << 20,
  gb: 1 << 30,
  tb: Math.pow(1024, 4),
  pb: Math.pow(1024, 5),
}

const parseRegExp = /^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i

function bytes (value, options) {
  if (typeof value === 'string') {
    return parse(value)
  }

  if (typeof value === 'number') {
    return format(value, options)
  }

  return null
}

function format (value, options) {
  if (!Number.isFinite(value)) {
    return null
  }

  const mag = Math.abs(value)
  const thousandsSeparator = (options && options.thousandsSeparator) || ''
  const unitSeparator = (options && options.unitSeparator) || ''
  const decimalPlaces = (options && options.decimalPlaces !== undefined) ? options.decimalPlaces : 2
  const fixedDecimals = Boolean(options && options.fixedDecimals)
  let unit = (options && options.unit) || ''

  if (!unit || !map[unit.toLowerCase()]) {
    if (mag >= map.pb) {
      unit = 'PB'
    } else if (mag >= map.tb) {
      unit = 'TB'
    } else if (mag >= map.gb) {
      unit = 'GB'
    } else if (mag >= map.mb) {
      unit = 'MB'
    } else if (mag >= map.kb) {
      unit = 'KB'
    } else {
      unit = 'B'
    }
  }

  const val = value / map[unit.toLowerCase()]
  let str = val.toFixed(decimalPlaces)

  if (!fixedDecimals) {
    str = str.replace(formatDecimalsRegExp, '$1')
  }

  if (thousandsSeparator) {
    str = str.replace(formatThousandsRegExp, thousandsSeparator)
  }

  return str + unitSeparator + unit
}

function parse (val) {
  if (typeof val === 'number' && !isNaN(val)) {
    return val
  }

  if (typeof val !== 'string') {
    return null
  }

  const results = parseRegExp.exec(val)
  let floatValue
  let unit = 'b'

  if (!results) {
    floatValue = parseInt(val, 10)
    unit = 'b'
  } else {
    floatValue = parseFloat(results[1])
    unit = results[4].toLowerCase()
  }

  return Math.floor(map[unit] * floatValue)
}

export default bytes
```

utils.js
```javascript
import { Message } from 'element-ui'
import bytes from './bytes'
import axios from 'axios'

/**
 * @author houjiazong
 * @description æ ¡éªŒæ–‡ä»¶è§„æ ¼ï¼ˆå¤§å°ï¼Œç±»å‹ï¼‰
 * @param {String} maxSize è¯­ä¹‰åŒ–å®šä¹‰æœ€å¤§å€¼ï¼Œå¦‚1kb, 1mb, 1gb, 1tb, 1pb
 * @param {String} ext æ–‡ä»¶ç±»å‹ï¼Œé»˜è®¤ä¸ºæ”¯æŒæ‰€æœ‰(*)ï¼Œä¹Ÿå¯æ ¡éªŒå¤šç§, å¦‚'.png,.pdf,'
 * @param {String} errorMsg æ ¡éªŒä¸é€šè¿‡æ‰€æç¤ºçš„é”™è¯¯ä¿¡æ¯ï¼Œæ”¯æŒå ä½ç¬¦æ›¿æ¢ï¼Œå¦‚'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡%ms%, æ‰€é€‰æ–‡ä»¶å¤§å°%fs%, å…è®¸æ–‡ä»¶ç±»å‹ä¸º%ext%, å®é™…æ–‡ä»¶ç±»å‹%fsext%'
 * @returns {Boolean} æ ¡éªŒæ˜¯å¦é€šè¿‡
 */
export function checkFileSpecs ({
  maxSize,
  ext = '*',
  errorMsg = 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡%ms%, æ‰€é€‰æ–‡ä»¶å¤§å°%fs%, å…è®¸æ–‡ä»¶ç±»å‹ä¸º%ext%, å®é™…æ–‡ä»¶ç±»å‹%fsext%',
}) {
  return file => {
    if (!(file instanceof File)) {
      return Message.error('æ ¡éªŒå¯¹è±¡å¿…é¡»ä¸ºFileå¯¹è±¡')
    }
    const { name: fileName, size: fileSize } = file
    // å¤„ç†æ–‡ä»¶ç±»å‹
    // å°†ä¼ é€’çš„extè½¬æ¢ä¸ºæ•°ç»„
    const accpectExt = ext.split(',').map(item => item.trim())
    // è·å–æ–‡ä»¶ç±»å‹
    const fileExt = fileName.substr(fileName.lastIndexOf('.')).toLowerCase()
    // æ ¡éªŒæ–‡ä»¶ç±»å‹æ˜¯å¦ç¬¦åˆå®šä¹‰çš„è§„åˆ™
    const validateExt = accpectExt.some(item => item === '*' || fileExt === item)

    // å¤„ç†æ–‡ä»¶å¤§å°
    // å°†ä¼ å…¥maxSizeç»Ÿä¸€è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    const maxSizeByte = bytes(maxSize)

    const fileSizeStr = bytes(fileSize)

    // ç”Ÿæˆé”™è¯¯ä¿¡æ¯
    const info = {
      ms: maxSize,
      fs: fileSizeStr,
      ext,
      fsext: fileExt,
    }
    const msg = errorMsg.replace(/%(.*?)%/g, (str, key) => {
      return info[key] || str
    })
    if (!validateExt) {
      Message.warning(msg)
      return false
    }
    const validateSize = maxSizeByte > file.size
    if (!validateSize) {
      Message.warning(msg)
      return false
    }
    return true
  }
}

/**
 * @author houjiazong
 * @description æœ¬åœ°ä¸‹è½½
 * @param {Object} data
 * @param {String} filename
 * @param {String} mime ç±»å‹
 * @param {Object} bom æ•°æ®å¤´
 */
export function download (data, filename = 'download', mime = 'application/octet-stream', bom) {
  const blobData = (typeof bom !== 'undefined') ? [bom, data] : [data]
  const blob = new Blob(blobData, { type: mime })

  if (typeof window.navigator.msSaveBlob !== 'undefined') {
    window.navigator.msSaveBlob(blob, filename)
  } else {
    const blobURL = window.URL.createObjectURL(blob)
    const tempLink = document.createElement('a')
    tempLink.style.display = 'none'
    tempLink.href = blobURL
    tempLink.setAttribute('download', filename)

    if (typeof tempLink.download === 'undefined') {
      tempLink.setAttribute('target', '_blank')
    }
    document.body.appendChild(tempLink)
    tempLink.click()
    document.body.removeChild(tempLink)
    window.URL.revokeObjectURL(blobURL)
  }
}

/**
 * @author houjiazong
 * @description ä¸‹è½½ossæ–‡ä»¶
 * @param {String} id æ–‡ä»¶ID
 * @param {String} name æ–‡ä»¶åç§°
 * @param {Boolean} save æ˜¯å¦æ‰§è¡Œæœ¬åœ°ä¸‹è½½
 * @returns {Blob | undefined} æ–‡ä»¶æµæˆ–undefined
 */
export async function ossFileDownload (id, name, save = true) {
  try {
    const response = await axios({
      url: '/v1/file/download',
      method: 'GET',
      responseType: 'blob',
      params: { id },
    })
    if (response.retCode && response.retCode === '500') {
      return
    }
    if (save) {
      download(response, name)
    } else {
      return response
    }
  } catch (error) {
    console.error(error)
  }
}

/**
 * @author houjiazong
 * @deprecated æŒ‚è½½åˆ°Upload on-previewäº‹ä»¶çš„ä¸‹è½½æ–¹æ³•
 * @param {String} idKey æ–‡ä»¶idçš„keyï¼Œé»˜è®¤å€¼id
 * @param {String} nameKey æ–‡ä»¶nameçš„key, é»˜è®¤å€¼name
 * @returns {Function}
 */
export function downFileForPreview (idKey = 'id', nameKey = 'name') {
  return file => {
    if (file[idKey]) {
      return ossFileDownload(file[idKey], file[nameKey])
    }
    if (file.raw) {
      return download(file.raw, file[nameKey])
    }
  }
}

/**
 * @author houjiazong
 * @description æ ¹æ®æœ¬åœ°æ–‡ä»¶å¯¹è±¡æˆ–æœåŠ¡ç«¯è¿”å›çš„æ–‡ä»¶ä¿¡æ¯ç”Ÿæˆbase64ï¼Œå¯ç”¨ä½œæœ¬åœ°é¢„è§ˆ
 * @param {Object} data å¯ä»¥ä¸ºFileå¯¹è±¡æˆ–æœåŠ¡ç«¯è¿”å›çš„æ–‡ä»¶ä¿¡æ¯{id: id, name: name}
 * @param {String} idKey æ–‡ä»¶idçš„keyï¼Œé»˜è®¤å€¼id
 * @param {String} nameKey æ–‡ä»¶nameçš„key, é»˜è®¤å€¼name
 * @returns {Promise}
 */
export async function ossFileToBase64 (data, idKey = 'id', nameKey = 'name') {
  let _data
  if (data instanceof File) {
    _data = data
  } else {
    try {
      _data = await ossFileDownload(data[idKey], data[nameKey], false)
    } catch (error) {
      console.error(error)
      return Promise.resolve()
    }
  }
  const reader = new FileReader()
  reader.readAsDataURL(_data)
  return new Promise((resolve, reject) => {
    reader.onload = function () {
      resolve(this.result)
    }
    reader.onerror = function () {
      reject(this.error)
    }
  })
}
```

å°†æ‰€æœ‰UtilsæŒ‚è½½åˆ°VueåŸå‹ä¸‹

```javascript
import {
  downFileForPreview,
  ossFileDownload,
  ossFileToBase64,
  checkFileSpecs,
} from '@/utils/utils'

export default {
  install: Vue => {
    // å¯ä»¥èµ‹å€¼ç»™ç»„ä»¶çš„on-previewï¼ˆç‚¹å‡»æ–‡ä»¶åˆ—è¡¨ä¸­å·²ä¸Šä¼ çš„æ–‡ä»¶æ—¶çš„é’©å­ï¼‰ï¼Œå¯ä»¥è¿›è¡Œæ–‡ä»¶çš„ä¸‹è½½
    Vue.prototype.$downFileForPreview = downFileForPreview
    // OSSæ–‡ä»¶ä¸‹è½½
    Vue.prototype.$ossFileDownload = ossFileDownload
    // å°†OSSæ–‡ä»¶æˆ–æœ¬åœ°æ–‡ä»¶å¯¹è±¡è½¬ä¸ºBase64
    Vue.prototype.$ossFileToBase64 = ossFileToBase64
    // æ ¡éªŒæ–‡ä»¶è§„æ ¼ï¼ˆå¤§å°ï¼Œç±»å‹ï¼‰
    Vue.prototype.$checkFileSpecs = checkFileSpecs
  },
}
```

æœ€ç»ˆçš„ä¸€ä¸ªå°ğŸŒ°
```html
<template>
  <el-card>
    <m-oss-upload
      class="upload-demo"
      :on-preview="handlePreview"
      :on-remove="handleRemove"
      :before-upload="$checkFileSpecs({
        maxSize: '500kb',
        ext: '.png, pdf',
        errorMsg: 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡%ms%, æ‰€é€‰æ–‡ä»¶å¤§å°%fs%, å…è®¸æ–‡ä»¶ç±»å‹ä¸º%ext%, å®é™…æ–‡ä»¶ç±»å‹%fsext%'
      })"
      multiple
      :limit="3"
      :on-exceed="handleExceed"
      :file-list="fileList">
      <el-button size="small" type="maiaPlain">ç‚¹å‡»ä¸Šä¼ </el-button>
      <div slot="tip" class="el-upload__tip">åªèƒ½ä¸Šä¼ jpg/pngæ–‡ä»¶ï¼Œä¸”ä¸è¶…è¿‡500kb</div>
    </m-oss-upload>
  </el-card>
</template>
```
```javascript
export default {
  data () {
    return {
      fileList: [],
    }
  },
  methods: {
    handleRemove (file, fileList) {
      console.log(file, fileList)
    },
    handlePreview (file) {
      console.log(file)
    },
    handleExceed (files, fileList) {
      this.$message.warning(`å½“å‰é™åˆ¶é€‰æ‹© 3 ä¸ªæ–‡ä»¶ï¼Œæœ¬æ¬¡é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶ï¼Œå…±é€‰æ‹©äº† ${files.length + fileList.length} ä¸ªæ–‡ä»¶`)
    },
  },
}
</script>
```
